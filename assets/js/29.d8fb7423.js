(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{509:function(s,e,a){"use strict";a.r(e);var n=a(4),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[s._v("#")]),s._v(" 准备")]),s._v(" "),a("p",[s._v("首先准备好最新版本的Python")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rm -rf /usr/local/python3\n./configure --prefix=/usr/local/python3/\nmake && make install\nrm -rf /usr/local/bin/python3\nln -s /usr/local/python3/bin/python3 /usr/local/bin/python3\nrm -rf /usr/local/bin/pip3\nln -s /usr/local/python3/bin/pip3 /usr/local/bin/pip3\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("因为我用的是宝塔环境，宝塔自带了Nginx和Supervisor，所以不用单独安装了")]),s._v(" "),a("p",[s._v("然后把代码上传到opt目录，我的上传到了"),a("code",[s._v("YojigenAPI")]),s._v("目录下")]),s._v(" "),a("p",[s._v("这里我是使用了PyCharm的自带"),a("code",[s._v("Deployment")]),s._v("功能进行代码上传")]),s._v(" "),a("p",[s._v("首先打开PyCharm的菜单栏的Tools --\x3e Deployment --\x3e Configure")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/1.jpg",alt:""}})]),s._v(" "),a("p",[s._v("在里面添加一个新的服务器，我添加的服务器命名为"),a("code",[s._v("AliyunHK")]),s._v("，输入好服务器的登陆信息")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/2.jpg",alt:""}})]),s._v(" "),a("p",[s._v("然后到Mappings页面，添加一下文件夹对应的路径配置，我这里是将代码放到了服务器的"),a("code",[s._v("/opt/YojigenAPI")]),s._v("目录下")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/3.jpg",alt:""}})]),s._v(" "),a("p",[s._v("最后到Excluded Paths页面，添加一个Local Path，忽略掉本地的venv虚拟环境文件夹")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/4.jpg",alt:""}})]),s._v(" "),a("p",[s._v("最后点击PyCharm的菜单栏的Tools --\x3e Deployment --\x3e Upload to AliyunHK，就可以将代码推送到服务器上了")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/5.jpg",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"环境配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境配置"}},[s._v("#")]),s._v(" 环境配置")]),s._v(" "),a("p",[s._v("ssh登陆到服务器，来到项目目录下，先创建一个虚拟环境")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("virtualenv -p /usr/local/bin/python3 --no-site-packages venv\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后进入到虚拟环境里")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("source venv/bin/activate\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("之后恢复pip的包")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pip install -r requirements.txt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("注意这里安装了"),a("code",[s._v("gunicorn")]),s._v("，默认的Django项目是不会安装的")]),s._v(" "),a("p",[s._v("包都装完了，就可以退出虚拟环境了")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("deactivate\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"服务配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务配置"}},[s._v("#")]),s._v(" 服务配置")]),s._v(" "),a("p",[s._v("先测试一下服务启动命令，10000是监听端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("venv/bin/gunicorn YojigenAPI.wsgi -b 0.0.0.0:10000\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("结果发现报错了，"),a("code",[s._v("The SECRET_KEY setting must not be empty.")]),s._v("，这个错误是项目配置文件找不到了，实际上是因为需要设置一下配置文件的环境变量才行，所以只要运行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('venv/bin/gunicorn YojigenAPI.wsgi -b 0.0.0.0:10000 -e DJANGO_SETTINGS_MODULE="YojigenAPI.settings.prod"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("之后再启动，如果没错那就没问题了")]),s._v(" "),a("p",[s._v("然而我又报错了，"),a("code",[s._v("SQLite 3.8.3 or later is required (found 3.7.17).")]),s._v("，这个问题是因为我用的是CentOS，系统自带的sqlite3版本太老，升级一下就可以了")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("./configure --prefix=/usr/local\nmake & make install\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("编译好了之后，执行一下这个，把/usr/local/lib添加到系统的链接库中")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('echo "/usr/local/lib" >> /etc/ld.so.conf\n/sbin/ldconfig\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("之后再运行应该就可以正常启动了，然后配置更新一下数据库，以及转存一下静态文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("venv/bin/python manage.py migrate --settings=YojigenAPI.settings.prod\nvenv/bin/python manage.py createsuperuser --settings=YojigenAPI.settings.prod\nvenv/bin/python manage.py collectstatic --settings=YojigenAPI.settings.prod\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("接下来就是配置Supervisor守护进程了，因为我用了宝塔，宝塔里面有现成的Supervisor管理器，这里就直接使用宝塔的管理器了")]),s._v(" "),a("p",[s._v("填写进去启动信息，保存即可")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/mouyase/Yojigen.Tech@gh-pages/assets/26/6.jpg",alt:""}})]),s._v(" "),a("p",[s._v("最后就是大家都熟悉的Nginx配置反向代理了，反向代理到对应的域名上就可以了，不过这里有个坑，是关于静态文件的，宝塔默认的配置里包含了css和js的相关配置，要去给他删了才行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("location /\n{\n\tproxy_pass http://127.0.0.1:10000;\n\tproxy_set_header Host api.yojigen.tech;\n\tproxy_set_header X-Real-IP $remote_addr;\n\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\tproxy_set_header REMOTE-HOST $remote_addr;\n\tadd_header X-Cache $upstream_cache_status;\n}\n\nlocation /static/ \n{\n\talias /opt/YojigenAPI/static/;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("到此配置全部完成，代码成功上线啦。")])])}),[],!1,null,null,null);e.default=t.exports}}]);